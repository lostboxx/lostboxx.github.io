<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω–∞—è –ø–∞–ø–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: black;
            color: white;
        }
        .screen {
            display: none;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(255,255,255,0.1);
            border: 1px solid #333;
        }
        .active {
            display: block;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #555;
        }
        input {
            background-color: #2a2a2a;
            color: white;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        .file-actions {
            display: flex;
            gap: 10px;
        }
        .add-file-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .error {
            color: #ff6b6b;
            margin-top: 5px;
        }
        .loading {
            color: #4CAF50;
            text-align: center;
            margin: 10px 0;
        }
        .logout-btn {
            background-color: #f44336;
            margin-top: 10px;
        }
        .logout-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
    <div id="welcome-screen" class="screen active">
        <h1>–õ–∏—á–Ω–∞—è –ø–∞–ø–∫–∞</h1>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ª–∏—á–Ω—É—é –ø–∞–ø–∫—É! <br> –í—ã —Ç—É—Ç –º–æ–∂–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ–∏ —Ñ–∞–π–ª—ã, –∏ –æ–Ω–∏ –±—É–¥—É—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã. <br> –ù–µ —Å—Ç–∞–≤—å—Ç–µ –ª–µ–≥–∫–∏–π –ø–∞—Ä–æ–ª—å, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —Ñ–∞–π–ª—ã –±—ã–ª–∏ –≤–∑–ª–æ–º–∞–Ω—ã. <br> –ù–µ –æ—á–∏—â–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–π—Ç–∞ "lostbox1000.neocities.org", —ç—Ç–æ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≤–∞—à–∏ —Ñ–∞–π–ª—ã –≤ –ª–∏—á–Ω–æ–π –ø–∞–ø–∫–µ. <br> –õ–∏—á–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 100% –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.  <br><br> –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è, –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞) –º–æ–∂–µ—Ç –¥–ª–∏—Ç—Å—è –¥–æ–ª–≥–æ, –∏–∑-–∑–∞ –º–æ—â–Ω–æ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –ó–∞—Ç–æ –Ω–∏–∫—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ —É–∫—Ä–∞–¥—ë—Ç —Ñ–æ—Ç–æ –∫–æ—Ç–∞! üòÉ –£–¥–∞—á–∏!</p>
        <button id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è -->
    <div id="create-password-screen" class="screen">
        <h2>–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å</h2>
        <input type="password" id="new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∞–∫—Å. 16 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="16">
        <input type="password" id="confirm-password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" maxlength="16">
        <div id="password-error" class="error"></div>
        <div id="password-loading" class="loading" style="display: none;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</div>
        <button id="set-password-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è -->
    <div id="login-screen" class="screen">
        <h2>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</h2>
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <div id="login-error" class="error"></div>
        <div id="login-loading" class="loading" style="display: none;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</div>
        <button id="login-btn">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ñ–∞–π–ª–æ–≤ -->
    <div id="files-screen" class="screen">
        <h2>–í–∞—à–∏ —Ñ–∞–π–ª—ã</h2>
        <div id="file-list"></div>
        <div id="upload-loading" class="loading" style="display: none;">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.</div>
        <button id="add-file-btn" class="add-file-btn">+</button>
        <button id="logout-btn" class="logout-btn">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <input type="file" id="file-input" style="display: none;">

    <script>
        // –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –≤—Å–µ–≥–æ –∫–æ–¥–∞ –≤ IIFE –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
        (function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            const screens = document.querySelectorAll('.screen');
            const welcomeScreen = document.getElementById('welcome-screen');
            const createPasswordScreen = document.getElementById('create-password-screen');
            const loginScreen = document.getElementById('login-screen');
            const filesScreen = document.getElementById('files-screen');
            const continueBtn = document.getElementById('continue-btn');
            const setPasswordBtn = document.getElementById('set-password-btn');
            const loginBtn = document.getElementById('login-btn');
            const addFileBtn = document.getElementById('add-file-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const fileInput = document.getElementById('file-input');
            const fileList = document.getElementById('file-list');
            const passwordError = document.getElementById('password-error');
            const loginError = document.getElementById('login-error');
            const passwordLoading = document.getElementById('password-loading');
            const loginLoading = document.getElementById('login-loading');
            const uploadLoading = document.getElementById('upload-loading');

            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è IndexedDB
            const DB_NAME = 'SecureFileStorage';
            const DB_VERSION = 2; // –£–≤–µ–ª–∏—á–∏–ª–∏ –≤–µ—Ä—Å–∏—é –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
            const STORE_PASSWORD = 'password';
            const STORE_FILES = 'files';

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ IIFE)
            let db = null;
            let encryptionKey = null;
            let inactivityTimer = null;
            const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.addEventListener('DOMContentLoaded', init);

            function init() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ IndexedDB:', event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    checkIfPasswordExists();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // –°–æ–∑–¥–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–∞—Ä–æ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if (!db.objectStoreNames.contains(STORE_PASSWORD)) {
                        db.createObjectStore(STORE_PASSWORD, { keyPath: 'id' });
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if (!db.objectStoreNames.contains(STORE_FILES)) {
                        const store = db.createObjectStore(STORE_FILES, { keyPath: 'id', autoIncrement: true });
                        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É)
                        store.createIndex('name', 'name', { unique: false });
                    }
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                continueBtn.addEventListener('click', onContinue);
                setPasswordBtn.addEventListener('click', setPassword);
                loginBtn.addEventListener('click', login);
                addFileBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileUpload);
                logoutBtn.addEventListener('click', logout);
                
                // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                document.addEventListener('click', resetInactivityTimer);
                document.addEventListener('keypress', resetInactivityTimer);
                document.addEventListener('mousemove', resetInactivityTimer);
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —É–∂–µ –ø–∞—Ä–æ–ª—å
            function checkIfPasswordExists() {
                const transaction = db.transaction([STORE_PASSWORD], 'readonly');
                const store = transaction.objectStore(STORE_PASSWORD);
                const request = store.get(1);
                
                request.onsuccess = (event) => {
                    const result = event.target.result;
                    if (result) {
                        // –ü–∞—Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                        showScreen(loginScreen);
                    } else {
                        // –ü–∞—Ä–æ–ª—è –Ω–µ—Ç, –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                        showScreen(welcomeScreen);
                    }
                };
                
                request.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è:', event.target.error);
                };
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            function onContinue() {
                const transaction = db.transaction([STORE_PASSWORD], 'readonly');
                const store = transaction.objectStore(STORE_PASSWORD);
                const request = store.get(1);
                
                request.onsuccess = (event) => {
                    const result = event.target.result;
                    if (result) {
                        // –ü–∞—Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                        showScreen(loginScreen);
                    } else {
                        // –ü–∞—Ä–æ–ª—è –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
                        showScreen(createPasswordScreen);
                    }
                };
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
            async function setPassword() {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!newPassword) {
                    passwordError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    passwordError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                    return;
                }
                
                passwordError.textContent = '';
                passwordLoading.style.display = 'block';
                setPasswordBtn.disabled = true;
                
                try {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–ª—å
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –ø–∞—Ä–æ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PBKDF2
                    const keyMaterial = await getKeyMaterial(newPassword);
                    encryptionKey = await deriveEncryptionKey(keyMaterial, salt);
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö–µ—à –ø–∞—Ä–æ–ª—è —Å —Å–æ–ª—å—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PBKDF2
                    const hashBuffer = await hashPassword(newPassword, salt);
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ö–µ—à –∏ —Å–æ–ª—å –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–µ—à –∏ —Å–æ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                    const transaction = db.transaction([STORE_PASSWORD], 'readwrite');
                    const store = transaction.objectStore(STORE_PASSWORD);
                    
                    store.put({
                        id: 1,
                        hash: hashHex,
                        salt: saltHex
                    });
                    
                    transaction.oncomplete = () => {
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É —Ñ–∞–π–ª–æ–≤
                        showScreen(filesScreen);
                        loadFiles();
                        resetInactivityTimer(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    };
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞—Ä–æ–ª—è:', error);
                    passwordError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞—Ä–æ–ª—è';
                } finally {
                    passwordLoading.style.display = 'none';
                    setPasswordBtn.disabled = false;
                }
            }

            // –í—Ö–æ–¥ —Å –ø–∞—Ä–æ–ª–µ–º
            async function login() {
                const password = document.getElementById('password').value;
                
                if (!password) {
                    loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                    return;
                }
                
                loginError.textContent = '';
                loginLoading.style.display = 'block';
                loginBtn.disabled = true;
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Ö–µ—à –∏ —Å–æ–ª—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                    const transaction = db.transaction([STORE_PASSWORD], 'readonly');
                    const store = transaction.objectStore(STORE_PASSWORD);
                    const request = store.get(1);
                    
                    request.onsuccess = async (event) => {
                        try {
                            const result = event.target.result;
                            if (!result) {
                                loginError.textContent = '–ü–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                                return;
                            }
                            
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º hex —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤—ã –±–∞–π—Ç–æ–≤
                            const storedHash = new Uint8Array(result.hash.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                            const salt = new Uint8Array(result.salt.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                            
                            // –•–µ—à–∏—Ä—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å —Ç–æ–π –∂–µ —Å–æ–ª—å—é
                            const hashBuffer = await hashPassword(password, salt);
                            const enteredHash = new Uint8Array(hashBuffer);
                            
                            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö–µ—à–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∞—Ç–∞–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                            if (enteredHash.length !== storedHash.length) {
                                loginError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                                return;
                            }
                            
                            let equal = true;
                            for (let i = 0; i < enteredHash.length; i++) {
                                if (enteredHash[i] !== storedHash[i]) {
                                    equal = false;
                                    break;
                                }
                            }
                            
                            if (equal) {
                                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –ø–∞—Ä–æ–ª—è
                                const keyMaterial = await getKeyMaterial(password);
                                encryptionKey = await deriveEncryptionKey(keyMaterial, salt);
                                
                                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É —Ñ–∞–π–ª–æ–≤
                                showScreen(filesScreen);
                                loadFiles();
                                resetInactivityTimer(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                            } else {
                                loginError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è:', error);
                            loginError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è';
                        } finally {
                            loginLoading.style.display = 'none';
                            loginBtn.disabled = false;
                        }
                    };
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:', error);
                    loginError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ';
                    loginLoading.style.display = 'none';
                    loginBtn.disabled = false;
                }
            }

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ –ø–∞—Ä–æ–ª—è
            async function getKeyMaterial(password) {
                const encoder = new TextEncoder();
                return await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
            }

            // –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PBKDF2
            async function deriveEncryptionKey(keyMaterial, salt) {
                return await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 500000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    {
                        name: 'AES-GCM',
                        length: 256
                    },
                    false,
                    ['encrypt', 'decrypt']
                );
            }

            // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è —Å —Å–æ–ª—å—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PBKDF2
            async function hashPassword(password, salt) {
                const encoder = new TextEncoder();
                const keyMaterial = await getKeyMaterial(password);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º PBKDF2 –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ö–µ—à–∞ –ø–∞—Ä–æ–ª—è
                return await crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    256 // 256 –±–∏—Ç = 32 –±–∞–π—Ç–∞
                );
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            async function loadFiles() {
                if (!db) return;
                
                const transaction = db.transaction([STORE_FILES], 'readonly');
                const store = transaction.objectStore(STORE_FILES);
                const request = store.getAll();
                
                request.onsuccess = async (event) => {
                    const files = event.target.result;
                    fileList.innerHTML = '';
                    
                    if (files.length === 0) {
                        fileList.innerHTML = '<p>–§–∞–π–ª–æ–≤ –Ω–µ—Ç</p>';
                        return;
                    }
                    
                    for (const file of files) {
                        await displayFile(file);
                    }
                };
                
                request.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤:', event.target.error);
                };
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ
            async function displayFile(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileName = document.createElement('span');
                
                try {
                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                    const nameBuffer = await crypto.subtle.decrypt(
                        {
                            name: 'AES-GCM',
                            iv: new Uint8Array(file.nameIv)
                        },
                        encryptionKey,
                        file.encryptedName
                    );
                    const name = new TextDecoder().decode(nameBuffer);
                    fileName.textContent = name;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞:', error);
                    fileName.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–π–ª (–æ—à–∏–±–∫–∞)';
                }
                
                fileName.style.cursor = 'pointer';
                fileName.addEventListener('click', () => previewFile(file));
                
                const actions = document.createElement('div');
                actions.className = 'file-actions';
                
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚è¨';
                downloadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    downloadFile(file);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(file.id);
                });
                
                actions.appendChild(downloadBtn);
                actions.appendChild(deleteBtn);
                
                fileItem.appendChild(fileName);
                fileItem.appendChild(actions);
                
                fileList.appendChild(fileItem);
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
            async function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                uploadLoading.style.display = 'block';
                
                try {
                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ ArrayBuffer
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º IV –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞
                    const fileIv = crypto.getRandomValues(new Uint8Array(12));
                    
                    // –®–∏—Ñ—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
                    const encryptedData = await crypto.subtle.encrypt(
                        {
                            name: 'AES-GCM',
                            iv: fileIv
                        },
                        encryptionKey,
                        arrayBuffer
                    );
                    
                    // –®–∏—Ñ—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                    const nameIv = crypto.getRandomValues(new Uint8Array(12));
                    const nameBuffer = new TextEncoder().encode(file.name);
                    const encryptedName = await crypto.subtle.encrypt(
                        {
                            name: 'AES-GCM',
                            iv: nameIv
                        },
                        encryptionKey,
                        nameBuffer
                    );
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                    const transaction = db.transaction([STORE_FILES], 'readwrite');
                    const store = transaction.objectStore(STORE_FILES);
                    
                    store.put({
                        encryptedName: encryptedName,
                        nameIv: Array.from(nameIv),
                        type: file.type,
                        size: file.size,
                        data: encryptedData,
                        iv: Array.from(fileIv)
                    });
                    
                    transaction.oncomplete = () => {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                        loadFiles();
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
                        fileInput.value = '';
                        uploadLoading.style.display = 'none';
                    };
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
                    uploadLoading.style.display = 'none';
                }
            }

            // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ ArrayBuffer
            function readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            async function downloadFile(file) {
                try {
                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                    const nameBuffer = await crypto.subtle.decrypt(
                        {
                            name: 'AES-GCM',
                            iv: new Uint8Array(file.nameIv)
                        },
                        encryptionKey,
                        file.encryptedName
                    );
                    const fileName = new TextDecoder().decode(nameBuffer);
                    
                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
                    const decryptedData = await crypto.subtle.decrypt(
                        {
                            name: 'AES-GCM',
                            iv: new Uint8Array(file.iv)
                        },
                        encryptionKey,
                        file.data
                    );
                    
                    // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const blob = new Blob([decryptedData], { type: file.type });
                    
                    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    
                    // –û—á–∏—â–∞–µ–º
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
                }
            }

            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞
            async function previewFile(file) {
                try {
                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
                    const decryptedData = await crypto.subtle.decrypt(
                        {
                            name: 'AES-GCM',
                            iv: new Uint8Array(file.iv)
                        },
                        encryptionKey,
                        file.data
                    );
                    
                    // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const blob = new Blob([decryptedData], { type: file.type });
                    const url = URL.createObjectURL(blob);
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                    const newWindow = window.open(url, '_blank');
                    
                    // –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    if (newWindow) {
                        newWindow.onload = () => URL.revokeObjectURL(url);
                    } else {
                        setTimeout(() => URL.revokeObjectURL(url), 100);
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Ñ–∞–π–ª–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
                }
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            function deleteFile(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) return;
                
                const transaction = db.transaction([STORE_FILES], 'readwrite');
                const store = transaction.objectStore(STORE_FILES);
                store.delete(id);
                
                transaction.oncomplete = () => {
                    loadFiles();
                };
                
                transaction.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', event.target.error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                };
            }

            // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
            function logout() {
                // –û—á–∏—â–∞–µ–º –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
                encryptionKey = null;
                
                // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                if (inactivityTimer) {
                    clearTimeout(inactivityTimer);
                    inactivityTimer = null;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                showScreen(loginScreen);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
                document.getElementById('password').value = '';
                loginError.textContent = '';
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                fileList.innerHTML = '';
            }

            // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            function resetInactivityTimer() {
                if (inactivityTimer) {
                    clearTimeout(inactivityTimer);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                if (encryptionKey) {
                    inactivityTimer = setTimeout(logout, INACTIVITY_TIMEOUT);
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
            function showScreen(screen) {
                screens.forEach(s => s.classList.remove('active'));
                screen.classList.add('active');
            }
        })();
    </script>
</body>
</html>