<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–ü—Ä—ã–≥–∞—é—â–∏–π –ñ—ë–ª—Ç—ã–π –ú—è—á–∏–∫</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      touch-action: none; 
    }
    html, body { 
      width: 100%; 
      height: 100%; 
      overflow: hidden; 
      background: transparent;
    }
    canvas { 
      display: block; 
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
      width: 100%;
      height: 100%;
    }
    #ui { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      color: #333; 
      font-family: "Segoe UI", sans-serif; 
      font-size: 12px; 
      text-shadow: 1px 1px 2px white; 
      z-index: 10; 
      background: rgba(255, 255, 255, 0.7);
      padding: 4px 8px;
      border-radius: 15px;
      font-weight: bold;
    }
    #win-screen { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: rgba(255,255,255,0.95); 
      padding: 15px; 
      border-radius: 10px; 
      box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
      display: none; 
      text-align: center; 
      z-index: 20; 
      width: 80%; 
      max-width: 200px; 
      border: 2px solid #4CAF50;
    }
    #win-screen div { 
      font-size: 16px; 
      color: #2E7D32; 
      margin-bottom: 12px; 
      font-weight: bold;
    }
    #win-screen button { 
      padding: 8px 12px; 
      font-size: 12px; 
      border: none; 
      border-radius: 20px; 
      background: linear-gradient(to right, #4CAF50, #2E7D32);
      color: white; 
      cursor: pointer; 
      width: 100%; 
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="ui">–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span></div>
  <div id="win-screen">
    <div>–ü–æ–±–µ–¥–∞! üèÜ</div>
    <button id="btn-next">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
  </div>
  <canvas id="game"></canvas>
  
  <script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è
    const TOTAL_PLATFORMS = 28;
    const STAR_PLATFORMS = [4, 8, 12, 16, 20, 24, 28];
    const GRAVITY = 0.25;
    const JUMP_VY = -5.5;
    const MOVE_SPEED = 2.2;
    // –í–æ—Ç —ç—Ç–æ —è —É–≤–µ–ª–∏—á–∏–ª –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–±—Ä–æ—Å–∞, –∫–∞–∫ —Ç—ã –∏ —Ö–æ—Ç–µ–ª!
    const MAX_X_STEP = 150; 
    const PLATFORM_WIDTH = 60;
    const PLATFORM_HEIGHT = 5;
    const STAR_RADIUS = 8;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const uiLevel = document.getElementById('level');
    const winScreen = document.getElementById('win-screen');
    const btnNext = document.getElementById('btn-next');

    let level = 1;
    let starsCollected = 0;
    let platforms = [];
    let stars = [];
    let ball = { x: 0, y: 0, radius: 7, vx: 0, vy: 0, lastY: 0 };
    let moving = { left: false, right: false };
    let totalLevelsCompleted = 0;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–µ—Å–∞–π–∑
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initLevel();
      resetBall();
    }
    window.addEventListener('resize', resize);

    // –£—Ä–æ–≤–µ–Ω—å (–û—Ç–∫–∞—á–µ–Ω–Ω—ã–π –∏ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∫–æ–¥)
function initLevel() {
  platforms = [];
  stars = [];
  starsCollected = 0;
  winScreen.style.display = 'none';

  const vSpacing = canvas.height / (TOTAL_PLATFORMS + 1);
  let prevX = canvas.width / 2 - PLATFORM_WIDTH / 2;
  
  // –ó–¥–µ—Å—å —è —É–±—Ä–∞–ª –Ω–∞—Ö—É–π –≤—Å—é —Ç–≤–æ—é –ª–æ–≥–∏–∫—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–∞–∂–¥–æ–π 3-–π –ø–ª–∏—Ç—ã.
  // –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø–ª–∏—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å –±–æ–ª—å—à–∏–º —Ä–∞–∑–±—Ä–æ—Å–æ–º (MAX_X_STEP = 150),
  // –∫–∞–∫ —Ç—ã –∏ –ø—Ä–æ—Å–∏–ª.
  for (let i = 1; i <= TOTAL_PLATFORMS; i++) {
    const y = canvas.height - vSpacing * i;
    
    let x, step;
    let validPosition = false;
    let attempts = 0;

    while (!validPosition && attempts < 20) {
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–æ–ª—å—à–æ–≥–æ —à–∞–≥–∞ (–¥–æ 150 –≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É)
      step = (Math.random() * 2 - 1) * MAX_X_STEP;
      x = prevX + step;
      
      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞
      x = Math.max(15, Math.min(x, canvas.width - PLATFORM_WIDTH - 15));
      attempts++;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–ª–∏—Ç–∞ –Ω–µ *—Å–ª–∏—à–∫–æ–º* –±–ª–∏–∑–∫–æ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π. 
      // –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è, —Å—Ç–∞—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.
      validPosition = Math.abs(x - prevX) >= 15;
    }
    
    platforms.push({ x, y, w: PLATFORM_WIDTH, h: PLATFORM_HEIGHT });
    
    if (STAR_PLATFORMS.includes(i)) {
      stars.push({ 
        x: x + PLATFORM_WIDTH/2, 
        y: y - STAR_RADIUS - 6, 
        r: STAR_RADIUS, 
        collected: false
      });
    }
    prevX = x;
  }
}

    // –°–±—Ä–æ—Å –º—è—á–∞
    function resetBall() {
      const p = platforms[0];
      ball.x = p.x + p.w / 2;
      ball.y = p.y - ball.radius - 1;
      ball.vx = 0;
      ball.vy = 0;
      ball.lastY = ball.y;
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤–æ–π –∑–≤–µ–∑–¥—ã
    function drawStar(x, y, radius) {
      ctx.save();
      ctx.translate(x, y);
      
      // –û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–ª–æ –∑–≤–µ–∑–¥—ã
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const outerAng = i * 2 * Math.PI / 5 - Math.PI/2;
        const innerAng = outerAng + Math.PI / 5;
        
        const outerX = Math.cos(outerAng) * radius;
        const outerY = Math.sin(outerAng) * radius;
        const innerX = Math.cos(innerAng) * (radius * 0.4);
        const innerY = Math.sin(innerAng) * (radius * 0.4);
        
        if (i === 0) {
          ctx.moveTo(outerX, outerY);
        } else {
          ctx.lineTo(outerX, outerY);
        }
        ctx.lineTo(innerX, innerY);
      }
      ctx.closePath();
      
      // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∑–≤–µ–∑–¥—ã
      const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
      gradient.addColorStop(0, '#FFF9C4');
      gradient.addColorStop(0.7, '#FFEB3B');
      gradient.addColorStop(1, '#FFC107');
      
      ctx.fillStyle = gradient;
      ctx.fill();
      
      // –ë–ª–∏–∫ –Ω–∞ –∑–≤–µ–∑–¥–µ
      ctx.beginPath();
      ctx.arc(-radius*0.3, -radius*0.3, radius*0.2, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.fill();
      
      // –ö–æ–Ω—Ç—É—Ä –∑–≤–µ–∑–¥—ã
      ctx.strokeStyle = '#FF9800';
      ctx.lineWidth = 1.2;
      ctx.stroke();
      
      ctx.restore();
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // –§–æ–Ω
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#87CEEB');
      gradient.addColorStop(1, '#E0F7FA');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
      platforms.forEach(p => {
        // –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
        ctx.fillStyle = '#5D4037';
        ctx.fillRect(p.x, p.y, p.w, p.h);
        
        // –í–µ—Ä—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        ctx.fillStyle = '#8D6E63';
        ctx.fillRect(p.x, p.y, p.w, 1.5);
      });

      // –ó–≤—ë–∑–¥—ã
      stars.forEach(s => {
        if (!s.collected) {
          drawStar(s.x, s.y, s.r);
        }
      });

      // –ú—è—á
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
      ctx.fillStyle = '#FFEB3B';
      ctx.fill();
      
      ctx.strokeStyle = '#F57F17';
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // –ë–ª–∏–∫ –Ω–∞ –º—è—á–µ
      ctx.beginPath();
      ctx.arc(
        ball.x - ball.radius/3, 
        ball.y - ball.radius/3, 
        ball.radius/3, 
        0, 
        Math.PI*2
      );
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.fill();
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π
    function checkCollision() {
      const nextY = ball.y + ball.vy;
      
      for (const p of platforms) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ X
        const withinX = ball.x + ball.radius > p.x && 
                       ball.x - ball.radius < p.x + p.w;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Y
        const wasAbove = ball.lastY + ball.radius <= p.y;
        const nowInside = nextY + ball.radius >= p.y && 
                         nextY + ball.radius <= p.y + p.h;
        
        // –ö–æ–ª–ª–∏–∑–∏—è —Å–≤–µ—Ä—Ö—É
        if (ball.vy > 0 && wasAbove && nowInside && withinX) {
          ball.y = p.y - ball.radius - 0.5;
          ball.vy = JUMP_VY;
          return;
        }
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–∑–∏–∫–∏
    function update() {
      ball.lastY = ball.y;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é
      ball.vy += GRAVITY;
      
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
      if (moving.left) ball.vx = -MOVE_SPEED;
      else if (moving.right) ball.vx = MOVE_SPEED;
      else ball.vx *= 0.85;

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
      ball.x += ball.vx;
      ball.y += ball.vy;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π
      checkCollision();

      // –°–±–æ—Ä –∑–≤—ë–∑–¥
      stars.forEach(s => {
        if (!s.collected) {
          const dx = ball.x - s.x;
          const dy = ball.y - s.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          
          if (distance < ball.radius + s.r * 0.6) {
            s.collected = true;
            starsCollected++;
            
            if (starsCollected === stars.length) {
              winScreen.style.display = 'block';
            }
          }
        }
      });

      // –ü–∞–¥–µ–Ω–∏–µ
      if (ball.y - ball.radius > canvas.height + 50) resetBall();
      
      // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
      if (ball.x < ball.radius) ball.x = ball.radius;
      if (ball.x > canvas.width - ball.radius) ball.x = canvas.width - ball.radius;
    }

    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function startMove(isLeft) {
      moving.left = isLeft;
      moving.right = !isLeft;
    }
    
    function endMove() {
      moving.left = moving.right = false;
    }

    // –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
    canvas.addEventListener('mousedown', e => {
      startMove(e.clientX < canvas.width/2);
    });
    
    canvas.addEventListener('mouseup', endMove);
    canvas.addEventListener('mouseleave', endMove);
    
    // –°–æ–±—ã—Ç–∏—è –∫–∞—Å–∞–Ω–∏—è
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const x = e.touches[0].clientX;
      startMove(x < canvas.width/2);
    });
    
    canvas.addEventListener('touchend', endMove);
    canvas.addEventListener('touchcancel', endMove);
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('touchmove', e => {
      if (e.scale !== 1) e.preventDefault();
    }, { passive: false });

    // –ö–Ω–æ–ø–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    btnNext.addEventListener('click', () => {
      level++;
      uiLevel.textContent = level;
      saveProgress();
      initLevel();
      resetBall();
    });

    // ============== IndexedDB –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ==============
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    function initDB() {
      const request = indexedDB.open('BallGameDB', 1);
      
      request.onerror = function(event) {
        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', event.target.error);
      };
      
      request.onupgradeneeded = function(event) {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('progress')) {
          db.createObjectStore('progress', { keyPath: 'id' });
        }
      };
      
      request.onsuccess = function(event) {
        const db = event.target.result;
        loadProgress(db);
      };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function loadProgress(db) {
      const transaction = db.transaction(['progress'], 'readonly');
      const store = transaction.objectStore('progress');
      const request = store.get('gameProgress');
      
      request.onsuccess = function(event) {
        const data = event.target.result;
        if (data) {
          level = data.level || 1;
          totalLevelsCompleted = data.totalLevelsCompleted || 0;
          
          uiLevel.textContent = level;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        resize();
        loop();
      };
      
      request.onerror = function(event) {
        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', event.target.error);
        resize();
        loop();
      };
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function saveProgress() {
      const request = indexedDB.open('BallGameDB', 1);
      
      request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(['progress'], 'readwrite');
        const store = transaction.objectStore('progress');
        
        store.put({ 
          id: 'gameProgress', 
          level: level,
          totalLevelsCompleted: totalLevelsCompleted 
        });
      };
      
      request.onerror = function(event) {
        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', event.target.error);
      };
    }
    
    // ============== –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã ==============
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    initDB();
  </script>
</body>
</html>
