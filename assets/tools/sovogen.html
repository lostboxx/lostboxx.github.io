<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–≤—É–∫–æ–≤—ã—Ö –≤–æ–ª–Ω</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 30px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; font-size: 2.2em; margin-bottom: 8px; }
        .header p { color: #7f8c8d; font-size: 1.1em; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-label { font-weight: 600; color: #2c3e50; font-size: 0.95em; }
        select, input[type="range"] { padding: 10px; border: 2px solid #e0e0e0; font-size: 1em; }
        .value-display { text-align: center; font-weight: 600; color: #3498db; font-size: 1.1em; }
        .wave-display { background: #1a1a1a; 10px; margin-bottom: 20px; overflow: hidden; position: relative; }
        canvas { width: 100%; height: 200px; display: block; }
        .real-wave { background: #2d2d2d; }
        .buttons { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 15px 25px; border: none; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .play-btn { background: #27ae60; color: white; flex: 1; }
        .play-btn:hover { background: #219a52; }
        .play-btn.playing { background: #e74c3c; }
        .init-btn { background: #3498db; color: white; flex: 1; }
        .init-btn:hover { background: #2980b9; }
        .init-btn.activated { background: #27ae60; }
        .record-btn { background: #e67e22; color: white; }
        .record-btn.recording { background: #c0392b; }
        .status { text-align: center; padding: 10px; font-weight: 500; }
        .status.playing { background: #d5f4e6; color: #27ae60; }
        .status.stopped { background: #f2dede; color: #e74c3c; }
        .status.recording { background: #fcf3cf; color: #d35400; }
        .wave-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .info-card { background: #f8f9fa; padding: 15px; text-align: center; }
        .info-label { font-size: 0.9em; color: #7f8c8d; margin-bottom: 5px; }
        .info-value { font-size: 1.2em; font-weight: 600; color: #2c3e50; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px;  margin-bottom: 20px; text-align: center; }
        .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; background: #ecf0f1; border: none; cursor: pointer; }
        .mode-btn.active { background: #3498db; color: white; }
        @media (max-width: 768px) { .controls, .wave-info { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–≤—É–∫–æ–≤—ã—Ö –≤–æ–ª–Ω + –û—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ</h1>
            <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—É–∫–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</p>
        </div>
        
        <div class="warning">‚ö†Ô∏è –î–ª—è –æ—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ–∞ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
        
        <div class="mode-switch">
            <button id="modeGen" class="mode-btn active">üéµ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–æ–ª–Ω</button>
            <button id="modeOsc" class="mode-btn">üìä –û—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ</button>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label class="control-label">–¢–∏–ø –≤–æ–ª–Ω—ã</label>
                <select id="waveType">
                    <option value="sine">–°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è</option>
                    <option value="square">–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è</option>
                    <option value="sawtooth">–ü–∏–ª–æ–æ–±—Ä–∞–∑–Ω–∞—è</option>
                    <option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∞—è</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">–ß–∞—Å—Ç–æ—Ç–∞: <span id="freqValue">440</span> –ì—Ü</label>
                <input type="range" id="freqSlider" min="20" max="2000" value="440" step="1">
            </div>
            
            <div class="control-group">
                <label class="control-label">–ì—Ä–æ–º–∫–æ—Å—Ç—å: <span id="volValue">50</span>%</label>
                <input type="range" id="volSlider" min="0" max="100" value="50">
            </div>
            
            <div class="control-group">
                <label class="control-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                <select id="duration">
                    <option value="short">1 —Å–µ–∫—É–Ω–¥–∞</option>
                    <option value="medium" selected>3 —Å–µ–∫—É–Ω–¥—ã</option>
                    <option value="long">5 —Å–µ–∫—É–Ω–¥</option>
                    <option value="continuous">–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ</option>
                </select>
            </div>
        </div>
        
        <div class="wave-display">
            <canvas id="waveCanvas"></canvas>
        </div>
        
        <div class="buttons">
            <button id="playBtn" class="play-btn">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
            <button id="initBtn" class="init-btn">üéµ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ</button>
            <button id="recordBtn" class="record-btn">‚è∫Ô∏è –ó–∞–ø–∏—Å—å (1 –º–∏–Ω)</button>
        </div>
        
        <div id="status" class="status stopped">–ù–∞–∂–º–∏—Ç–µ "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ"</div>
        
        <div class="wave-info">
            <div class="info-card">
                <div class="info-label">–¢–∏–ø –≤–æ–ª–Ω—ã</div>
                <div id="currentWaveType" class="info-value">–°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è</div>
            </div>
            <div class="info-card">
                <div class="info-label">–ß–∞—Å—Ç–æ—Ç–∞</div>
                <div id="currentFreq" class="info-value">440 –ì—Ü</div>
            </div>
            <div class="info-card">
                <div class="info-label">–ì—Ä–æ–º–∫–æ—Å—Ç—å</div>
                <div id="currentVol" class="info-value">50%</div>
            </div>
            <div class="info-card">
                <div class="info-label">–†–µ–∂–∏–º</div>
                <div id="currentMode" class="info-value">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let audioContext = null
            let oscillator = null
            let isPlaying = false
            let isInitialized = false
            let isRecording = false
            let mediaRecorder = null
            let recordedChunks = []
            let analyser = null
            let microphone = null
            let isOscilloscopeMode = false
            let recordingTimeout = null
            
            const waveTypeSelect = document.getElementById('waveType')
            const freqSlider = document.getElementById('freqSlider')
            const freqValue = document.getElementById('freqValue')
            const volSlider = document.getElementById('volSlider')
            const volValue = document.getElementById('volValue')
            const durationSelect = document.getElementById('duration')
            const playBtn = document.getElementById('playBtn')
            const initBtn = document.getElementById('initBtn')
            const recordBtn = document.getElementById('recordBtn')
            const statusDiv = document.getElementById('status')
            const waveCanvas = document.getElementById('waveCanvas')
            const ctx = waveCanvas.getContext('2d')
            const modeGen = document.getElementById('modeGen')
            const modeOsc = document.getElementById('modeOsc')
            
            const currentWaveType = document.getElementById('currentWaveType')
            const currentFreq = document.getElementById('currentFreq')
            const currentVol = document.getElementById('currentVol')
            const currentMode = document.getElementById('currentMode')
            
            function initAudio() {
                if (isInitialized) return
                
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)()
                    isInitialized = true
                    initBtn.textContent = '‚úÖ –ê—É–¥–∏–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ'
                    initBtn.classList.add('activated')
                    initBtn.disabled = true
                    statusDiv.textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ'
                    statusDiv.className = 'status stopped'
                } catch (error) {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ'
                }
            }
            
            function initOscilloscope() {
                if (!isInitialized) {
                    statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∞—É–¥–∏–æ'
                    return
                }
                
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then(function(stream) {
                        microphone = audioContext.createMediaStreamSource(stream)
                        analyser = audioContext.createAnalyser()
                        analyser.fftSize = 2048
                        microphone.connect(analyser)
                        
                        waveCanvas.parentElement.classList.add('real-wave')
                        statusDiv.textContent = '–û—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'
                        drawRealWaveform()
                    })
                    .catch(function(err) {
                        statusDiv.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É'
                        console.error('Microphone error:', err)
                    })
            }
            
            function resizeCanvas() {
                waveCanvas.width = waveCanvas.offsetWidth
                waveCanvas.height = waveCanvas.offsetHeight
                if (!isOscilloscopeMode) drawWaveform()
            }
            
            function drawWaveform() {
                const width = waveCanvas.width
                const height = waveCanvas.height
                const centerY = height / 2
                
                ctx.fillStyle = '#1a1a1a'
                ctx.fillRect(0, 0, width, height)
                
                ctx.strokeStyle = '#3498db'
                ctx.lineWidth = 2
                ctx.beginPath()
                
                const frequency = parseInt(freqSlider.value)
                const waveType = waveTypeSelect.value
                const points = 200
                
                for (let i = 0; i <= points; i++) {
                    const x = (i / points) * width
                    let y = centerY
                    
                    const t = (i / points) * Math.PI * 4
                    
                    switch(waveType) {
                        case 'sine':
                            y = centerY + Math.sin(t * frequency / 100) * (height / 3)
                            break
                        case 'square':
                            y = centerY + (Math.sin(t * frequency / 100) > 0 ? 1 : -1) * (height / 3)
                            break
                        case 'sawtooth':
                            y = centerY + (2 * (t * frequency / 100 / (2 * Math.PI) - Math.floor(0.5 + t * frequency / 100 / (2 * Math.PI)))) * (height / 3)
                            break
                        case 'triangle':
                            y = centerY + (2 * Math.abs(2 * (t * frequency / 100 / (2 * Math.PI) - Math.floor(t * frequency / 100 / (2 * Math.PI) + 0.5)) - 1)) * (height / 3)
                            break
                    }
                    
                    if (i === 0) {
                        ctx.moveTo(x, y)
                    } else {
                        ctx.lineTo(x, y)
                    }
                }
                
                ctx.stroke()
            }
            
            function drawRealWaveform() {
                if (!analyser || !isOscilloscopeMode) return
                
                const bufferLength = analyser.fftSize
                const dataArray = new Uint8Array(bufferLength)
                analyser.getByteTimeDomainData(dataArray)
                
                const width = waveCanvas.width
                const height = waveCanvas.height
                
                ctx.fillStyle = '#2d2d2d'
                ctx.fillRect(0, 0, width, height)
                
                ctx.lineWidth = 2
                ctx.strokeStyle = '#e74c3c'
                ctx.beginPath()
                
                const sliceWidth = width * 1.0 / bufferLength
                let x = 0
                
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0
                    const y = v * height / 2
                    
                    if (i === 0) {
                        ctx.moveTo(x, y)
                    } else {
                        ctx.lineTo(x, y)
                    }
                    
                    x += sliceWidth
                }
                
                ctx.lineTo(width, height / 2)
                ctx.stroke()
                
                if (isOscilloscopeMode) {
                    requestAnimationFrame(drawRealWaveform)
                }
            }
            
            function updateDisplay() {
                freqValue.textContent = freqSlider.value
                volValue.textContent = volSlider.value
                
                currentWaveType.textContent = waveTypeSelect.options[waveTypeSelect.selectedIndex].text
                currentFreq.textContent = freqSlider.value + ' –ì—Ü'
                currentVol.textContent = volSlider.value + '%'
                
                if (!isOscilloscopeMode) drawWaveform()
            }
            
            function startRecording() {
                if (!isInitialized || !isPlaying) {
                    statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ'
                    return
                }
                
                if (isRecording) return
                
                try {
                    recordedChunks = []
                    const destination = audioContext.createMediaStreamDestination()
                    oscillator.connect(destination)
                    
                    mediaRecorder = new MediaRecorder(destination.stream)
                    
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data)
                        }
                    }
                    
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, { type: 'audio/wav' })
                        const url = URL.createObjectURL(blob)
                        const a = document.createElement('a')
                        a.style.display = 'none'
                        a.href = url
                        a.download = 'soundwave_' + Date.now() + '.wav'
                        document.body.appendChild(a)
                        a.click()
                        setTimeout(() => {
                            document.body.removeChild(a)
                            URL.revokeObjectURL(url)
                        }, 100)
                    }
                    
                    mediaRecorder.start()
                    isRecording = true
                    recordBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å'
                    recordBtn.classList.add('recording')
                    statusDiv.textContent = '–ó–∞–ø–∏—Å—å... 1 –º–∏–Ω—É—Ç–∞'
                    statusDiv.className = 'status recording'
                    
                    // –ê–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
                    recordingTimeout = setTimeout(stopRecording, 60000)
                    
                } catch (error) {
                    console.error('Recording error:', error)
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏'
                }
            }
            
            function stopRecording() {
                if (!isRecording || !mediaRecorder) return
                
                mediaRecorder.stop()
                isRecording = false
                recordBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å—å (1 –º–∏–Ω)'
                recordBtn.classList.remove('recording')
                statusDiv.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
                statusDiv.className = 'status stopped'
                
                if (recordingTimeout) {
                    clearTimeout(recordingTimeout)
                    recordingTimeout = null
                }
            }
            
            function playSound() {
                if (!isInitialized) {
                    statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∞—É–¥–∏–æ'
                    return
                }
                
                if (isPlaying) return
                
                try {
                    isPlaying = true
                    oscillator = audioContext.createOscillator()
                    const gainNode = audioContext.createGain()
                    
                    oscillator.type = waveTypeSelect.value
                    oscillator.frequency.value = parseInt(freqSlider.value)
                    gainNode.gain.value = parseInt(volSlider.value) / 100
                    
                    oscillator.connect(gainNode)
                    gainNode.connect(audioContext.destination)
                    
                    oscillator.start()
                    
                    playBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'
                    playBtn.classList.add('playing')
                    statusDiv.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...'
                    statusDiv.className = 'status playing'
                    
                    const duration = durationSelect.value
                    if (duration !== 'continuous') {
                        const times = { short: 1000, medium: 3000, long: 5000 }
                        setTimeout(stopSound, times[duration])
                    }
                } catch (error) {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è'
                    isPlaying = false
                }
            }
            
            function stopSound() {
                if (!isPlaying || !oscillator) return
                
                try {
                    oscillator.stop()
                    oscillator = null
                    isPlaying = false
                    
                    playBtn.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏'
                    playBtn.classList.remove('playing')
                    statusDiv.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'
                    statusDiv.className = 'status stopped'
                    
                    if (isRecording) {
                        stopRecording()
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error)
                }
            }
            
            function switchToGenerator() {
                isOscilloscopeMode = false
                modeGen.classList.add('active')
                modeOsc.classList.remove('active')
                currentMode.textContent = '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä'
                waveCanvas.parentElement.classList.remove('real-wave')
                updateDisplay()
            }
            
            function switchToOscilloscope() {
                isOscilloscopeMode = true
     modeGen.classList.remove('active')
                modeOsc.classList.add('active')
                currentMode.textContent = '–û—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ'
                initOscilloscope()
            }
            
            modeGen.addEventListener('click', switchToGenerator)
            modeOsc.addEventListener('click', switchToOscilloscope)
            initBtn.addEventListener('click', initAudio)
            
            waveTypeSelect.addEventListener('change', updateDisplay)
            freqSlider.addEventListener('input', updateDisplay)
            volSlider.addEventListener('input', updateDisplay)
            
            playBtn.addEventListener('click', function() {
                if (isPlaying) {
                    stopSound()
                } else {
                    playSound()
                }
            })
            
            recordBtn.addEventListener('click', function() {
                if (isRecording) {
                    stopRecording()
                } else {
                    startRecording()
                }
            })
            
            window.addEventListener('resize', resizeCanvas)
            
            resizeCanvas()
            updateDisplay()
        })
    </script>
</body>
</html>