<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<title>–°–æ–∑–¥–∞—Ç—å –∑–≤—É–∫</title>
<style>
body { background: #111; color: #eee; font-family: sans-serif; text-align: center; padding: 20px; }
button { margin: 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
#helpBox, #playerBox, #downloadBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #222;
    border: 2px solid #444;
    padding: 20px;
    width: 300px;
    color: #fff;
    text-align: left;
    z-index: 1000;
}
#helpBox button.close, #playerBox button.close, #downloadBox button.close { float: right; background: red; color: #fff; border: none; cursor:pointer; }
textarea { width: 90%; height: 100px; margin-top: 15px; font-size: 20px; }
progress { width: 60%; margin-right: 10px; vertical-align: middle; }
span.length { margin-right: 10px; }
</style>
</head>
<body>

<h1>–°–æ–∑–¥–∞—Ç—å –∑–≤—É–∫</h1>
<h4>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–≤—É–∫–∞ —á–µ—Ä–µ–∑ —Å–º–∞–π–ª–∏–∫–∏!</h4>
<button onclick="showHelp()">–ü–æ–¥—Å–∫–∞–∑–∫–∏</button>

<div id="helpBox">
  <button class="close" onclick="closeHelp()">X</button>
  <h4>–û–±—É—á–µ–Ω–∏–µ –∑–≤—É–∫–∞–º:</h4>
  <p>üíÄ ‚Üê –°—Ç—Ä–∞—à–Ω–æ –≥—Ä–æ–º–∫–∏–π</p>
  <p>üü™ ‚Üê –û—á–µ–Ω—å –≥—Ä–æ–º–∫–∏–π</p>
  <p>üü• ‚Üê –ì—Ä–æ–º–∫–∏–π</p>
  <p>üüß ‚Üê –í—ã—à–µ –æ–±—ã—á–Ω–æ–≥–æ</p>
  <p>üü® ‚Üê –û–±—ã—á–Ω—ã–π</p>
  <p>üü© ‚Üê –ù–∏–∂–µ –æ–±—ã—á–Ω–æ–≥–æ</p>
  <p>üü¶ ‚Üê –¢–∏—Ö–∏–π</p>
  <p>–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–≤—É–∫, –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –≤–≤–µ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–º–∞–π–ª–∏–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
üü©üü©üü©üü™üü©üü©üü©
—ç—Ç–æ –±—É–¥–µ—Ç –∑–≤—É–∫, –≥–¥–µ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ —Ä–µ–∑–∫–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥—Ä–æ–º–∫–æ. </p>
</div>

<textarea id="sequence" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫—É–±–∏–∫–∏..."></textarea><br>
<button onclick="playSoundWithUI()">–ü—Ä–æ—Å–ª—É—à–∞—Ç—å</button>
<button onclick="downloadSound()">–°–∫–∞—á–∞—Ç—å</button>

<div id="playerBox">
  <button class="close" onclick="closePlayer()">X</button><br><br>
  <progress id="progressBar" value="0" max="100"></progress>
  <span class="length" id="timeDisplay">0.0s</span>
  <button id="playPauseBtn">‚è∏Ô∏è</button>
</div>

<div id="downloadBox">
  <button class="close" onclick="closeDownloadBox()">X</button>
  <p>–§–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è<span id="dots"></span></p>
</div>

<script>
const notes = {
  "üíÄ": 5000,
  "üü™": 900,
  "üü•": 880,
  "üüß": 660,
  "üü®": 550,
  "üü©": 440,
  "üü¶": 330,
  "‚¨õ": 0
};

let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let oscList = [];
let gainList = [];
let startTime = 0, isPaused = false, totalDuration = 0;
let progressInterval;

function showHelp() { document.getElementById('helpBox').style.display = 'block'; }
function closeHelp() { document.getElementById('helpBox').style.display = 'none'; }
function closePlayer() { 
    document.getElementById('playerBox').style.display = 'none'; 
    stopAllOsc();
    clearInterval(progressInterval);
    isPaused = false;
}
function closeDownloadBox() {
    document.getElementById('downloadBox').style.display = 'none'; 
}

function stopAllOsc() {
    for (let osc of oscList) osc.stop();
    oscList = [];
    gainList = [];
}

function playSoundWithUI() {
    const seq = document.getElementById('sequence').value;
    totalDuration = seq.length * 0.3;
    startTime = audioCtx.currentTime;
    isPaused = false;

    document.getElementById('playerBox').style.display = 'block';
    document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';

    stopAllOsc();
    let offset = 0;
    const baseTime = audioCtx.currentTime;

    for (let char of seq) {
        const freq = notes[char];
        const duration = 0.3;

        if (freq > 0) {
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, baseTime + offset);

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.3, baseTime + offset);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(baseTime + offset);
            osc.stop(baseTime + offset + duration);

            oscList.push(osc);
            gainList.push(gain);
        }
        offset += duration;
    }

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—Ä–µ–º—è
    const progressBar = document.getElementById('progressBar');
    const timeDisplay = document.getElementById('timeDisplay');
    progressInterval = setInterval(() => {
        if (!isPaused) {
            let elapsed = audioCtx.currentTime - startTime;
            if (elapsed >= totalDuration) elapsed = totalDuration;
            progressBar.value = (elapsed / totalDuration) * 100;
            timeDisplay.textContent = elapsed.toFixed(1) + 's';
            if (elapsed >= totalDuration) {
                clearInterval(progressInterval);
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                setTimeout(closePlayer, 5000);
            }
        }
    }, 50);

    // –ö–Ω–æ–ø–∫–∞ –ø–∞—É–∑—ã/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const playPauseBtn = document.getElementById('playPauseBtn');
    playPauseBtn.onclick = function() {
        if (!isPaused) {
            audioCtx.suspend();
            this.textContent = '‚ñ∂Ô∏è';
            isPaused = true;
        } else {
            audioCtx.resume();
            this.textContent = '‚è∏Ô∏è';
            isPaused = false;
        }
    };
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–≤—É–∫–∞
function downloadSound() {
  const seq = document.getElementById('sequence').value;
  if (seq.length === 0) return;

  document.getElementById('downloadBox').style.display = 'block';
  const dotsEl = document.getElementById('dots');
  dotsEl.textContent = '.';
  let dotInterval = setInterval(() => {
    if (dotsEl.textContent === '.') {
      dotsEl.textContent = '..';
    } else if (dotsEl.textContent === '..') {
      dotsEl.textContent = '...';
    } else if (dotsEl.textContent === '...') {
      dotsEl.textContent = '.';
    } else {
      dotsEl.textContent = '.';
    }
  }, 1000);

  const dest = audioCtx.createMediaStreamDestination();
  const recorder = new MediaRecorder(dest.stream);
  const chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = e => {
    clearInterval(dotInterval);
    document.getElementById('downloadBox').style.display = 'none';
    const blob = new Blob(chunks, { type: 'audio/wav' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `newmusic_${Date.now()}.wav`;
    a.click();
    URL.revokeObjectURL(url);
  };

  let offset = 0;
  const baseTime = audioCtx.currentTime;
  for (let char of seq) {
    const freq = notes[char];
    const duration = 0.3;
    if (freq > 0) {
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, baseTime + offset);

      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.3, baseTime + offset);

      osc.connect(gain);
      gain.connect(dest);

      osc.start(baseTime + offset);
      osc.stop(baseTime + offset + duration);
    }
    offset += duration;
  }

  recorder.start();
  setTimeout(() => recorder.stop(), seq.length * 300 + 50);
}
</script>

</body>
</html>